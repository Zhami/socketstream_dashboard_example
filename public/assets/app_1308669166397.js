(function(){SS.client.app||(SS.client.app={}),SS.client.app.init=function(){var buildApiUrl,renderLivePreview,scopeCSS;$("#overlay").live("click",function(){$(".dialogue").remove();return $(this).remove()}),window.widgetModel=new Model("Widget",function(){this.unique_key="_id";return this.include({bindWidgetHtmlAndCss:function(){var cssContainer;$("#widget_"+this.attributes._id).find(".content").html(this.attributes.html),cssContainer=$('<style type="text/css"></style>'),cssContainer.text(scopeCSS(this.attributes.css,this.attributes._id));return $("head").append(cssContainer)},executeCoffee:function(data){window.data=data;return CoffeeScript.run(this.attributes.coffee)}})}),widgetModel.bind("add",function(newObject){widgetTemplate.add(newObject.attributes);return newObject.bindWidgetHtmlAndCss()}),widgetModel.bind("remove",function(removedObject){return widgetTemplate.findInstance(removedObject.attributes._id).animate({opacity:0},1e3,function(){return widgetTemplate.remove(removedObject.attributes._id)})}),window.widgetTemplate=new SmartTemplate("widget",{bindDataToCssClasses:!0}),window.dialogueTemplate=new SmartTemplate("dialogue",{templateHtml:$($("#dialogs-dialog").html()),bindDataToCssClasses:!0,appendTo:$("body"),afterAdd:function(object){object.hide().fadeIn("slow"),object.draggable({handle:".dialogue-heading"});return object.find(".dialogue-close").click(function(){window.dialogueTemplate.remove(object.attr("id"));return $("#overlay").remove()})}}),SS.server.app.getWidgets(function(widgets){var widget,_i,_len,_results;_results=[];for(_i=0,_len=widgets.length;_i<_len;_i++)widget=widgets[_i],_results.push((new widgetModel(widget)).save());return _results}),$("#newWidget").click(function(){var dialogue;$("body").append("<div id='overlay'></div>"),$("#overlay").hide().fadeIn(),dialogueTemplate.add({id:"new","dialogue-title":"Create a new Widget"}),dialogue=dialogueTemplate.findInstance("new"),dialogue.find(".dialogue-content").html($($("#dialogs-widgetForm").html())),dialogue.css({top:""+(document.height-dialogue.height())/2+"px",left:""+(document.width-dialogue.width())/2+"px"}),$(".htmlContent textarea").val('<div class="value">âŒ›</div>'),$(".cssContent textarea").val(".value {\n\tpadding-top: 1em;\n\tfont-size: 8em;\n\tfont-weight: bold;\n\ttext-shadow: 1px 1px 1px black;\n\ttext-align: center;\n\tpadding-top: 0.5em;\n\tcolor: white;\n}"),$(".coffeeContent textarea").val('# All of your html is scoped to $("#widget_"+data.id)\n$("#widget_"+data.id).find(".value").text(data.value)'),$(".jsonContent textarea").val("{value: 0.24}"),renderLivePreview(),$('form#widget input[name="title"]').live("keyup",function(){return $(".demoContent").find(".title").text($("form#widget").find('input[name="title"]').val())}),$(".tab").click(function(){var id;$(".tab").removeClass("active"),$(".tabContent").removeClass("active"),$(this).addClass("active"),id=$(this).attr("id"),$("."+id+"Content").addClass("active");if(id==="demo")return renderLivePreview()});return $("form#widget").submit(function(){var data;data={title:$(this).find('input[name="title"]').val(),html:$(".htmlContent textarea").val(),css:$(".cssContent textarea").val(),coffee:$(".coffeeContent textarea").val(),json:$(".jsonContent textarea").val()},SS.server.app.createWidget(data,function(res){if(res===!1)return alert("Balls. Mongo doesn't like it :(");data._id=res._id,dialogueTemplate.remove("new"),dialogueTemplate.add({id:"new","dialogue-title":"Test your new Widget"}),dialogue=dialogueTemplate.findInstance("new"),dialogue.find(".dialogue-content").html("<p>Ping this url to send data to your widget:</p><code><a href='"+buildApiUrl(data)+"' target='_blank'>"+buildApiUrl(data)+"</a></code>");return dialogue.css({top:""+(document.height-dialogue.height())/2+"px",left:""+(document.width-dialogue.width())/2+"px"})});return!1})}),$("#widgets").sortable({handle:".title"}),SS.events.on("transmission",function(data){return widgetModel.find(data.id).executeCoffee(data)}),SS.events.on("addWidget",function(data){return(new widgetModel(data)).save()}),SS.events.on("removeWidget",function(id){return widgetModel.find(id).destroy()}),SS.events.on("updateWidget",function(data){var key,value,widget;widget=widgetModel.find(data._id);for(key in data)value=data[key],widget.attr(key,value);widget.save(),widgetTemplate.update(widgetModel.find(widget.id()).attributes);return widget.bindWidgetHtmlAndCss()}),SS.socket.on("disconnect",function(){return $("#message").text("SocketStream server has gone down :-(")}),SS.socket.on("connect",function(){return $("#message").text("SocketStream server is back up :-)")}),scopeCSS=function(text,id){var line,lines,_i,_len;lines=text.split("\n");for(_i=0,_len=lines.length;_i<_len;_i++)line=lines[_i],line.match(/{/)!==null&&(text=text.replace(line,"#widget_"+id+" "+line));return text},$(".delete").live("click",function(){var id,stopOwen;stopOwen=confirm("Do you want to delete this widget?");if(stopOwen===!0){id=$(this).parent().parent().attr("id").split("_")[1];return SS.server.app.deleteWidget(id,function(res){if(res!==!0)return alert("There was an error deleting the widget")})}}),$(".config").live("click",function(){var dialogue,id,widget;$("body").append("<div id='overlay'></div>"),$("#overlay").hide().fadeIn(),id=$(this).parent().parent().attr("id").split("_")[1],widget=widgetModel.find(id),dialogueTemplate.add({id:id,"dialogue-title":"Edit Widget: "+widget.attributes.title}),dialogue=dialogueTemplate.findInstance(id),dialogue.find(".dialogue-content").html($($("#dialogs-widgetForm").html())),dialogue.find(".dialogue-content #theBoringBit").prepend("<div class='apiUrl'><b>API URL:</b> <a href='"+buildApiUrl(widget.attributes)+"' target='_blank'>"+buildApiUrl(widget.attributes)+"</a></div>"),dialogue.css({top:""+(document.height-dialogue.height())/2+"px",left:""+(document.width-dialogue.width())/2+"px"}),$('form#widget input[type="submit"]').val("Save"),$(".htmlContent textarea").val(widget.attributes.html),$(".cssContent textarea").val(widget.attributes.css),$(".coffeeContent textarea").val(widget.attributes.coffee),$(".jsonContent textarea").val(widget.attributes.json),$("form#widget").find('input[name="title"]').val(widget.attributes.title),renderLivePreview(),$('form#widget input[name="title"]').live("keyup",function(){return $(".demoContent").find(".title").text($("form#widget").find('input[name="title"]').val())}),$(".tab").click(function(){$(".tab").removeClass("active"),$(".tabContent").removeClass("active"),$(this).addClass("active"),id=$(this).attr("id"),$("."+id+"Content").addClass("active");if(id==="demo")return renderLivePreview()});return $("form#widget").submit(function(){SS.server.app.updateWidget({_id:widget.id(),title:$(this).find('input[name="title"]').val(),html:$(".htmlContent textarea").val(),css:$(".cssContent textarea").val(),coffee:$(".coffeeContent textarea").val(),json:$(this).find(".jsonContent textarea").val()},function(res){if(res===!1)return alert("Balls. Mongo doesn't like it :(");dialogueTemplate.remove(widget.id());return $("#overlay").remove()});return!1})}),renderLivePreview=function(){var html,key,value;window.data={id:"preview"},html=$(".widget.template").clone().removeClass("template").attr("id","widget_preview").show(),html.find(".title").text($("form#widget").find('input[name="title"]').val()),html.find(".content").html($(".htmlContent textarea").val()),$(".demoContent").html(html),$("#cssHolder").html($(".cssContent textarea").val()),window.dataToMerge=eval("obj = "+$(".jsonContent textarea").val());for(key in dataToMerge)value=dataToMerge[key],data[key]=value;return CoffeeScript.run($(".coffeeContent textarea").val())};return buildApiUrl=function(data){var key,string,value,_ref;string=[],_ref=eval("obj = "+data.json);for(key in _ref)value=_ref[key],string.push("&"+key+"="+value);return""+document.location.href+"api/app/transmit?id="+data._id+string.join()}}}).call(this)